data:
  image: nccts/nccts-data:0.0.10
  # !!! REMEMBER TO SWITCH BACK TO TAGGED !!!
  # command: 'clone_site.sh tagged'
  command: 'clone_site.sh'
  volumes:
    - /home/sailor/nccts.org

update:
  image: nccts/nccts-data:0.0.10
  # !!! REMEMBER TO SWITCH BACK TO TAGGED !!!
  # command: 'pull_site.sh tagged'
  command: 'pull_site.sh'
  volumes_from:
    - data

# needs to be a docker-in-docker image built atop baseimage, but it probably shouldn't be made less generic than that
build:
  image: nccts/nccts-build:0.0.10
  # !!! REMEMBER !!!
  # the support scripts will be available owing to clone/update of repo by data,update services defined above
  # though I will want to reorg and revise them (i.e. w.r.t. paths, no longer anchored to fleet)
  command: |
    docker run -it --rm --volumes-from data --name static nccts/baseimage:latest '\
        source /home/sailor/.bashrc ; \

        /home/sailor/nccts.org/fleet/common/scripts/rsync-static.sh'

    docker run -it --rm --volumes-from data --name latex nccts/latex:latest '\
        source /home/sailor/.bashrc ; \
        export PATH=/usr/local/texlive/2014/bin/x86_64-linux:$PATH ; \

        export source_tex=/home/sailor/nccts.org/site/source/tex ; \
        export com_scripts=/home/sailor/nccts.org/fleet/common/scripts ; \

        mkdir -p $source_tex/build
        mkdir -p $source_tex/build/clcc

        $com_scripts/tex-build.sh pdf manual ; \
        # cannot run latexml build in mem constrained env < 4GB
        # $com_scripts/tex-build.sh xml manual ; \
        $com_scripts/tex-build.sh html manual ; \

        $com_scripts/tex-build.sh pdf companion ; \
        # cannot run latexml build in mem constrained env < 4GB
        # $com_scripts/tex-build.sh xml companion ; \
        $com_scripts/tex-build.sh html companion ; \

        $com_scripts/rsync-latex.sh'

    docker run -it --rm --volumes-from data --name generator nccts/clojure:latest '\
        source /home/sailor/.bashrc ; \

        cd /home/sailor/nccts.org ; \
        lein run ; \

        mkdir -p /home/sailor/nccts.org/site/source/clojure/build ; \

        /home/sailor/nccts.org/fleet/common/scripts/rsync-generator.sh'
  privileged: true
  volumes_from:
    - data

http:
  image: nccts/node:0.0.10
  command: |
    npm install -g http-server ; \
    cd nccts.org/site/build    ; \
    http-server -p 8080 -c7200 -d false -s
  ports:
    - "80:8080"
  volumes_from:
    - data
